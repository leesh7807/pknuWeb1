<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>공공데이터 + 카카오맵API</title>
  </head>
  <body>
    <select id="area" onchange="classifyMarkers()">
      <option value="전국">전국</option>
      <option value="서울특별시">서울</option>
      <option value="부산광역시">부산</option>
      <option value="대구광역시">대구</option>
      <option value="인천광역시">인천</option>
      <option value="광주광역시">광주</option>
      <option value="대전광역시">대전</option>
      <option value="울산광역시">울산</option>
      <option value="세종특별자치시">세종</option>
      <option value="경기도">경기</option>
      <option value="강원도">강원</option>
      <option value="충청북도">충북</option>
      <option value="충청남도">충남</option>
      <option value="전라북도">전북</option>
      <option value="전라남도">전남</option>
      <option value="경상북도">경북</option>
      <option value="경상남도">경남</option>
      <option value="제주특별자치도">제주</option>
    </select>
    <select id="type" onchange="classifyMarkers()">
      <option value="전체">전체</option>
      <option value="저수지">저수지</option>
      <option value="바다">바다</option>
      <option value="평지">평지</option>
      <option value="기타">기타</option>
    </select>
    <div id="map" style="width: 100%; height: 100vh"></div>
    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=서비스키&libraries=clusterer"></script>
    <script>
    var url = "http://api.data.go.kr/openapi/tn_pubr_public_fshlc_api";
    var queryParams = '?' + encodeURIComponent('serviceKey') + '='+'공공데이터키'; /*Service Key*/
        queryParams += '&' + encodeURIComponent('pageNo') + '=' + encodeURIComponent('1'); /**/
        queryParams += '&' + encodeURIComponent('numOfRows') + '=' + encodeURIComponent('707'); /**/
        queryParams += '&' + encodeURIComponent('type') + '=' + encodeURIComponent('json'); /**/ 
    var fishingPlace = new Array();
    var markers = new Array();
    // 인포윈도우 표시 열기
    function mouseOverListener(map, marker, infoWindow) {
      return function () {
        infoWindow.open(map, marker);
      };
    }
    // 인포윈도우 표시 닫기
    function mouseOutListener(infoWindow) {
      return function () {
        infoWindow.close();
      };
    }
    var mapContainer = document.getElementById("map"); // 지도를 표시할 div
    var mapOption = {
      center: new kakao.maps.LatLng(36.59000, 127.52855), // 지도의 중심좌표
      level: 12, // 지도의 확대 레벨
    };
    var map = new kakao.maps.Map(mapContainer, mapOption);
    var clusterer = new kakao.maps.MarkerClusterer({
      map: map, // 마커들을 클러스터로 관리하고 표시할 지도 객체
      averageCenter: true, // 클러스터에 포함된 마커들의 평균 위치를 클러스터 마커 위치로 설정
      minLevel: 5, // 클러스터 할 최소 지도 레벨
    });
    fetch(url + queryParams)
      .then((res) => res.json())
      .then((resJson) => {
        var centers = resJson.response.body.items;
        fishingPlace = centers;
        for (var i = 0; i < centers.length; i++) {
          var latitude = centers[i]["latitude"];
          var longitude = centers[i]["longitude"];
          var marker = new kakao.maps.Marker({
            position: new kakao.maps.LatLng(latitude, longitude),
            map: map,
          });

          var infoWindow = new kakao.maps.InfoWindow({
            content: centers[i]["fshlcNm"] + "<br>" + centers[i]["phoneNumber"]
          });
          // 마커 추가
          markers.push(marker);
          // 마커 이벤트리스너 등록
          kakao.maps.event.addListener(
            marker,
            "mouseover",
            mouseOverListener(map, marker, infoWindow)
          );
          kakao.maps.event.addListener(
            marker,
            "mouseout",
            mouseOutListener(infoWindow)
          );
        }
        clusterer.addMarkers(markers);
      });

      // 분류 함수
      function classifyMarkers(e) {
        // 셀렉트 박스에서 id로 value 가져오기.
        var target = document.getElementById("area");
        var areaValue = target.options[target.selectedIndex].value;
        var target = document.getElementById("type");
        var typeValue = target.options[target.selectedIndex].value;
        var classifiedArea = new Array();
        var classifiedFishingPlace = new Array(); // 분류된 fishingPlace가 저장될 json 배열.
        // 전국이 선택될 때
        if(areaValue == "전국") {
          classifiedArea = fishingPlace; // 분류된 것이 곧 fishingPlace.
        }
        // 그 외 지역 선택
        else {
          for(var i = 0; i < fishingPlace.length; i++) {
            var area = fishingPlace[i]["lnmadr"]; // 지번주소 받아오기.
            var splittedArea = area.split(" "); // 스페이스바를 기준으로 배열로 저장.
            if(areaValue == splittedArea[0]) { // 배열의 첫 요소는 곧 지역명.
              classifiedArea.push(fishingPlace[i]);
            }
          }
        }
        if(typeValue == "전체") {
          classifiedFishingPlace = classifiedArea; // 지역분류 된 결과 그대로
        }
        // 그 외 유형 선택
        else {
          for(var i = 0; i < classifiedArea.length; i++) {
            var type = classifiedArea[i]["fshlcType"]; // 낚시터 유형 받아오기.
            var splittedType = type.split(" "); // 스페이스바를 기준으로 배열로 저장.
            if(typeValue == splittedType[0]) { 
              classifiedFishingPlace.push(classifiedArea[i]);
            }
          }
        }
        // 분류를 마친 후 마커를 초기화 시킴.
        clusterer.removeMarkers(markers);
        markers = [];
        // 마커를 만들어 배열에 넣고 지도에 찍기.
        for(var i = 0; i < classifiedFishingPlace.length; i++) {
          var latitude = classifiedFishingPlace[i]["latitude"];
          var longitude = classifiedFishingPlace[i]["longitude"];
          var marker = new kakao.maps.Marker({
            position: new kakao.maps.LatLng(latitude, longitude),
            map: map,
          });
          var infoWindow = new kakao.maps.InfoWindow({
            content: classifiedFishingPlace[i]["fshlcNm"] + "<br>" + classifiedFishingPlace[i]["phoneNumber"]
          });
          // 마커 추가
          markers.push(marker);
          // 마커 이벤트리스너 등록
          kakao.maps.event.addListener(
            marker,
            "mouseover",
            mouseOverListener(map, marker, infoWindow)
          );
          kakao.maps.event.addListener(
            marker,
            "mouseout",
            mouseOutListener(infoWindow)
          );
        }
        clusterer.addMarkers(markers);
      }
    </script>
  </body>
</html>